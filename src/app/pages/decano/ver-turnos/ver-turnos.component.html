<!-- component -->
<div class="max-w-[100%] mx-auto">
  <!-- PANEL PRINCIPAL -->
  <div
    class="relative flex flex-col w-full h-full text-slate-700 bg-white rounded-2xl shadow-md ring-1 ring-slate-200/70 px-8 sm:px-12 py-6 sm:py-8 bg-clip-border"
  >
    <div class="relative overflow-hidden text-slate-700 bg-white rounded-2xl">
      <!-- Header -->
      <div
        class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-5 gap-3"
      >
        <div>
          <h3 class="text-2xl font-semibold text-slate-900">Lista Turno</h3>
          <p class="text-slate-500">Lista de todos los turnos:</p>
        </div>
      </div>

      <!-- Filtros -->
      <div
        class="flex flex-col sm:flex-row justify-between items-center gap-4 p-3 bg-slate-50/60 rounded-xl ring-1 ring-slate-200/70"
      >
        <div class="flex flex-wrap gap-2 items-center">
          <!-- Periodo -->
          <nz-select
            [(ngModel)]="filtros.n_codper"
            (ngModelChange)="onChangeFacultad('n_codper', $event)"
            class="w-auto h-[38px] rounded-xl"
          >
            <nz-option nzValue="" nzLabel="Periodo"></nz-option>
            <nz-option
              *ngFor="let p of periodos"
              [nzValue]="p.n_codper"
              [nzLabel]="p.n_codper"
            ></nz-option>
          </nz-select>

          <!-- Facultad (solo visible si el usuario tiene más de una) -->
          <nz-select
            *ngIf="showFacultad"
            [(ngModel)]="filtros.c_codfac"
            (ngModelChange)="onChangeFacultad('facultad', $event)"
            class="w-auto h-[38px] rounded-xl"
          >
            <nz-option nzValue="" nzLabel="Facultad"></nz-option>
            <nz-option nzValue="S" nzLabel="CIENCIAS DE LA SALUD"></nz-option>
            <nz-option nzValue="E" nzLabel="INGENIERÍA Y NEGOCIOS"></nz-option>
          </nz-select>

          <!-- Especialidades filtradas -->
          <nz-select
            [(ngModel)]="filtros.c_codesp"
            (ngModelChange)="onChangeFacultad('especialidad', $event)"
            class="w-[300px] h-[38px] rounded-xl"
          >
            <nz-option nzValue="" nzLabel="Especialidad"></nz-option>
            @for (especialidad of especialidadesFiltradas; track
            especialidad.codesp) {
            <nz-option
              [nzValue]="especialidad.codesp"
              [nzLabel]="especialidad.codesp + ' - ' + especialidad.nomesp"
            ></nz-option>
            }
          </nz-select>

          <!-- Modalidad -->
          <nz-select
            [(ngModel)]="filtros.c_codmod"
            (ngModelChange)="onChangeFacultad('modalidad', $event)"
            class="w-auto h-[38px] rounded-xl"
          >
            <nz-option nzValue="" nzLabel="Modalidad"></nz-option>
            <nz-option
              *ngFor="let mod of modalidades"
              [nzValue]="mod.value"
              [nzLabel]="mod.label"
            ></nz-option>
          </nz-select>

          <!-- Ciclo -->
          <nz-select
            [(ngModel)]="filtros.n_ciclo"
            (ngModelChange)="onChangeFacultad('ciclo', $event)"
            class="w-20 h-[38px] rounded-xl"
          >
            <nz-option nzValue="" nzLabel="Ciclo"></nz-option>
            <nz-option
              *ngFor="let i of ciclos"
              [nzValue]="i"
              [nzLabel]="i"
            ></nz-option>
          </nz-select>

          <!-- Estado -->
          <nz-select
            [(ngModel)]="filtros.estado"
            (ngModelChange)="onChangeFacultad('estado', $event)"
            class="w-auto h-[38px] rounded-xl"
          >
            <nz-option nzValue="" nzLabel="Estado"></nz-option>
            <nz-option nzValue="0" nzLabel="No asignado"></nz-option>
            <nz-option nzValue="1" nzLabel="Pendiente"></nz-option>
            <nz-option nzValue="2" nzLabel="Asignado"></nz-option>
          </nz-select>
        </div>

        <!-- Botón Crear Turno -->
        <div>
          <button
            (click)="mostrarModalCrear = true"
            class="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white font-semibold py-2 px-5 rounded-xl shadow-lg transition-all duration-300"
          >
            <i class="fa-solid fa-plus"></i>
            Crear Turno
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLA -->
  <div class="mt-5 bg-white rounded-xl shadow-sm ring-1 ring-slate-200/70 p-6">
    <div class="w-full overflow-x-auto rounded-xl">
      <div class="min-w-[1000px]">
        <nz-table
          #sortTable
          [nzData]="turnosPaginados"
          nzTableLayout="fixed"
          [nzFrontPagination]="false"
        >
          <thead class="bg-slate-50">
            <tr>
              @for (column of listOfColumn; track column) {
              <th
                class="text-slate-900 font-semibold"
                [nzWidth]="column.nzWidth"
                [nzSortFn]="column.compare"
              >
                {{ column.title }}
              </th>
              }
            </tr>
          </thead>

          <tbody class="divide-y divide-slate-100">
            @for (data of sortTable.data; track data) {
            <tr class="hover:bg-slate-50 transition-colors">
              <td class="text-slate-700">{{ data.n_codper }}</td>
              <td class="text-slate-700">{{ data.n_codpla }}</td>
              <td class="text-slate-700">{{ data.c_codfac }}</td>
              <td class="text-slate-700">{{ data.c_codesp }}</td>
              <td class="text-slate-700">{{ data.c_grpcur }}</td>
              <td class="text-slate-700">{{ data.n_ciclo }}</td>
              <td class="text-slate-700">{{ data.c_nommod }}</td>
              <td>
                <span
                  [ngClass]="{
                    'text-green-900 bg-green-500/20': data.estado === 2,
                    'text-yellow-700 bg-yellow-500/20': data.estado === 1,
                    'text-slate-600 bg-slate-200/60': data.estado === 0
                  }"
                  class="px-3 py-1 rounded-full text-xs font-semibold uppercase shadow-sm"
                >
                  {{
                    data.estado === 2
                      ? "asignado"
                      : data.estado === 0
                      ? "no asignado"
                      : "pendiente"
                  }}
                </span>
              </td>
              <td>
                <button
                  type="button"
                  (click)="clickAsignarHorario(data.id)"
                  class="text-slate-700 hover:text-slate-900 transition-colors"
                  title="Asignar horario"
                >
                  <i class="fa-solid fa-calendar-days fa-2x"></i>
                </button>
              </td>
            </tr>
            }
          </tbody>
        </nz-table>
      </div>
    </div>

    <!-- Paginación -->
    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 px-3 py-3"
    >
      <div class="flex items-center gap-2">
        <label for="cantidad" class="text-sm text-slate-500">Mostrar:</label>
        <select
          id="cantidad"
          [ngModel]="itemsPorPagina"
          (ngModelChange)="cambiarItemsPorPagina($event)"
          class="rounded-xl bg-white ring-1 ring-slate-200 px-4 py-1 text-sm text-slate-700 focus:ring-2 focus:ring-blue-500/50 transition"
        >
          <option *ngFor="let opt of opcionesPagina" [ngValue]="opt">
            {{ opt }}
          </option>
        </select>
      </div>

      <div class="flex items-center gap-3">
        <p class="text-sm text-slate-500">
          Página {{ paginaActual }} de {{ totalPaginas }}
        </p>
        <div class="flex gap-1">
          <button
            (click)="anteriorPagina()"
            [disabled]="paginaActual === 1"
            class="rounded-xl bg-white ring-1 ring-slate-200 py-2.5 px-3 text-xs font-semibold text-slate-600 transition hover:bg-slate-50 disabled:opacity-50"
          >
            Anterior
          </button>
          <button
            (click)="siguientePagina()"
            [disabled]="paginaActual === totalPaginas"
            class="rounded-xl bg-white ring-1 ring-slate-200 py-2.5 px-3 text-xs font-semibold text-slate-600 transition hover:bg-slate-50 disabled:opacity-50"
          >
            Siguiente
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CREAR TURNO -->
<div
  [hidden]="!mostrarModalCrear"
  class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50"
>
  <div class="bg-white p-6 rounded-xl shadow-xl w-full max-w-4xl">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-semibold">Crear nuevo Turno</h2>
      <button
        class="text-gray-500 hover:text-red-500"
        (click)="cerrarModalCrear()"
      >
        <i class="fa-solid fa-xmark text-xl"></i>
      </button>
    </div>

    <form
      [formGroup]="formularioHorario"
      class="grid grid-cols-1 md:grid-cols-2 gap-6"
    >
      <!-- Facultad (solo si el usuario tiene más de una) -->
      <div *ngIf="showFacultad">
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Facultad</label
        >
        <select
          formControlName="c_codfac"
          (change)="onChangeFacultadFormulario()"
          class="w-full border border-gray-300 rounded-md px-3 py-2"
        >
          <option value="">Seleccione facultad</option>
          <option value="S">CIENCIAS DE LA SALUD</option>
          <option value="E">INGENIERÍA Y NEGOCIOS</option>
        </select>
      </div>

      <!-- Especialidad (filtrada según permisos del usuario) -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Especialidad</label
        >
        <select
          formControlName="c_codesp"
          class="w-full border border-gray-300 rounded-md px-3 py-2"
        >
          <option value="">Seleccione especialidad</option>
          <option
            *ngFor="let esp of especialidadesFiltradas"
            [value]="esp.codesp"
          >
            {{ esp.nomesp }}
          </option>
        </select>
      </div>

      <!-- Periodo -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Periodo</label
        >
        <select
          formControlName="n_codper"
          class="w-full border border-gray-300 rounded-md px-3 py-2"
        >
          <option value="">Seleccione periodo</option>
          <option *ngFor="let per of periodos" [value]="per.n_codper">
            {{ per.n_codper }}
          </option>
        </select>
      </div>

      <!-- Plan -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Plan</label>
        <select
          formControlName="n_codpla"
          class="w-full border border-gray-300 rounded-md px-3 py-2"
        >
          <option value="">Seleccione plan</option>
          <option value="2023">2023</option>
          <option value="2025">2025</option>
        </select>
      </div>

      <!-- Sección -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Sección</label
        >
        <nz-select
          formControlName="c_grpcur"
          nzMode="multiple"
          nzPlaceHolder="Ej. S1, C3, N2"
          nzShowSearch
          (nzOnSearch)="onBuscarSeccion($event)"
          class="w-full"
        >
          <nz-option
            *ngFor="let opcion of seccionesSugeridas"
            [nzValue]="opcion"
            [nzLabel]="opcion"
          ></nz-option>
        </nz-select>
      </div>

      <!-- <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Sección</label
        >
        <input
          type="text"
          formControlName="c_grpcur"
          [nzAutocomplete]="autoSeccion"
          (input)="onInputSeccion($event)"
          (blur)="validarSeleccionSeccion()"
          class="w-full border border-gray-300 rounded-md px-3 py-2 uppercase"
          placeholder="Ej. S1, C3, N2"
        />

        <nz-autocomplete
          #autoSeccion
          (selectionChange)="onSeleccionarSeccion($event)"
        >
          <nz-auto-option
            *ngFor="let opcion of seccionesSugeridas"
            [nzValue]="opcion"
          >
            {{ opcion }}
          </nz-auto-option>
        </nz-autocomplete>
      </div> -->

      <!-- Ciclo -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Ciclo</label
        >
        <select
          formControlName="n_ciclo"
          class="w-full border border-gray-300 rounded-md px-3 py-2"
        >
          <option value="">Seleccione ciclo</option>
          <option *ngFor="let c of ciclos" [value]="c">{{ c }}</option>
        </select>
      </div>

      <!-- Modalidad -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Modalidad</label
        >
        <select
          formControlName="c_codmod"
          class="w-full border border-gray-300 rounded-md px-3 py-2"
        >
          <option value="">Seleccione modalidad</option>
          <option *ngFor="let mod of modalidades" [value]="mod.value">
            {{ mod.label }}
          </option>
        </select>
      </div>
    </form>

    <div class="mt-6 flex justify-end gap-3">
      <button
        class="px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-800 flex items-center justify-center gap-2"
        (click)="guardarTurno()"
        [disabled]="isSaving"
      >
        <ng-container *ngIf="!isSaving; else cargando"> Guardar </ng-container>

        <ng-template #cargando>
          <i class="fa-solid fa-spinner fa-spin"></i>
          Guardando...
        </ng-template>
      </button>
    </div>
  </div>
</div>
